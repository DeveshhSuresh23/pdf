<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Teacher Video</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div class="relative w-full h-full min-h-screen overflow-hidden bg-gray-900">
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20">
            <h1 class="text-white text-2xl font-bold rounded-full bg-slate-800 bg-opacity-70 px-4 py-2">Version 10</h1>
        </div>

        <video id="teacherVideo" class="fixed top-0 left-0 min-w-full min-h-full w-auto h-auto object-cover" autoplay muted playsinline loop>
            <source src="mainpage.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <div id="pdfOverlay" class="absolute z-10 p-2 overflow-y-auto no-scrollbar opacity-0 pointer-events-none" style="transition: opacity 0.3s ease-in-out;">
            <canvas id="pdfCanvas" class="w-full h-auto"></canvas>
        </div>

        <div id="statusMessage" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg hidden"></div>
        
        <div id="pageInfo" class="absolute top-4 right-4 text-white font-bold text-lg bg-slate-800 bg-opacity-70 rounded-full px-4 py-2 z-20 hidden"></div>

        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-4 z-20">
            <select id="pdfSelect" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-gray-800 transition duration-300">
                <option value="" disabled selected>Select a PDF</option>
                <option value="Definite Integral and Area - 3 Soft Copy.pdf">Definite Integral and Area - 3 Soft Copy</option>
                <option value="Definite Integral and Area - 3 ANSWERKEY.pdf">Definite Integral and Area - 3 ANSWERKEY</option>
                <option value="XII Chemistry Record.pdf">XII Chemistry Record</option>
                <!-- Change these to URLs if needed! -->
            </select>
            
            <button id="togglePdfBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 hidden">
                Hide PDF
            </button>
        </div>

        <div id="pdfNavLeft" class="absolute bottom-4 left-4 z-20 hidden">
            <button id="prevBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                Prev
            </button>
        </div>
        <div id="pdfNavRight" class="absolute bottom-4 right-4 z-20 hidden">
            <button id="nextBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300">
                Next
            </button>
        </div>

        <div id="notesSection" class="absolute top-1/2 left-4 -translate-y-1/2 z-20 bg-gray-800 bg-opacity-80 p-4 rounded-lg shadow-lg max-w-sm hidden">
            <h2 class="text-white text-lg font-bold mb-2">My Notes</h2>
            <div id="notesContainer" class="max-h-60 overflow-y-auto no-scrollbar mb-4 space-y-2"></div>
            <form id="noteForm" class="flex">
                <input type="text" id="noteInput" placeholder="Write a new note..." class="flex-grow rounded-l-full py-2 px-4 bg-gray-700 text-white focus:outline-none">
                <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-r-full hover:bg-green-700 transition duration-300">
                    Save
                </button>
            </form>
        </div>
    </div>

    <script>
        // Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpU8O3y-jGO9bAeerf7TFChwuwxF17C-I",
            authDomain: "pdfview-b4af4.firebaseapp.com",
            projectId: "pdfview-b4af4",
            storageBucket: "pdfview-b4af4.firebasestorage.app",
            messagingSenderId: "945235833304",
            appId: "1:945235833304:web:a7d3619c51c04c9dd282ad",
            measurementId: "G-Q5P99PYPD6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const pdfOverlay = document.getElementById('pdfOverlay');
        const pdfCanvas = document.getElementById('pdfCanvas');
        const pdfSelect = document.getElementById('pdfSelect');
        const togglePdfBtn = document.getElementById('togglePdfBtn');
        const statusMessage = document.getElementById('statusMessage');
        const pdfNavLeft = document.getElementById('pdfNavLeft');
        const pdfNavRight = document.getElementById('pdfNavRight');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        const notesSection = document.getElementById('notesSection');
        const notesContainer = document.getElementById('notesContainer');
        const noteForm = document.getElementById('noteForm');
        const noteInput = document.getElementById('noteInput');
        
        let pdfDoc = null;
        let currentPage = 1;
        let currentPdf = null;
        let notesUnsubscribe = null;

        const showStatusMessage = (message, color = "bg-red-600") => {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            statusMessage.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${color} text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg`;
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        };

        const updatePageNumberDisplay = () => {
            pageInfo.textContent = `Page ${currentPage} of ${pdfDoc.numPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === pdfDoc.numPages;
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        };

        const loadAndRenderPdf = async (url) => {
            showStatusMessage('Loading PDF...', 'bg-blue-600');
            try {
                if (!url) {
                    console.error('Error: URL is not valid or empty.');
                    showStatusMessage('No PDF selected.');
                    return;
                }
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;

                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                currentPage = 1;
                currentPdf = url;
                setOverlayDimensions();
                renderPage(currentPage);

                togglePdfBtn.style.display = 'block';
                pdfNavLeft.classList.remove('hidden');
                pdfNavRight.classList.remove('hidden');
                pageInfo.classList.remove('hidden');
                pdfOverlay.style.opacity = '1';
                pdfOverlay.style.pointerEvents = 'auto';
                notesSection.classList.remove('hidden');
                statusMessage.classList.add('hidden');
            } catch (error) {
                console.error('Error loading PDF:', error);
                showStatusMessage('Failed to load PDF. Make sure the file exists.');
                togglePdfBtn.style.display = 'none';
                pdfNavLeft.classList.add('hidden');
                pdfNavRight.classList.add('hidden');
                pageInfo.classList.add('hidden');
                notesSection.classList.add('hidden');
            }
        };

        const renderPage = async (pageNum) => {
            if (!pdfDoc) return;
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: pdfCanvas.width / page.view[2] });

                pdfCanvas.height = viewport.height;

                const renderContext = {
                    canvasContext: pdfCanvas.getContext('2d'),
                    viewport: viewport
                };
                await page.render(renderContext).promise;
                updatePageNumberDisplay();
            } catch (error) {
                console.error(`Error rendering page ${pageNum}:`, error);
                showStatusMessage('Error rendering PDF page.');
            }
        };

        const setOverlayDimensions = () => {
            const videoWidth = window.innerWidth;
            const videoHeight = window.innerHeight;
            pdfOverlay.style.top = `${videoHeight * 0.15}px`;
            pdfOverlay.style.left = `${videoWidth * 0.25}px`;
            pdfOverlay.style.width = `${videoWidth * 0.50}px`;
            pdfOverlay.style.height = `${videoHeight * 0.70}px`;
            pdfCanvas.width = pdfOverlay.clientWidth;
        };

        // Improved Notes Functions
        const saveNote = async (e) => {
            e.preventDefault();
            const noteText = noteInput.value.trim();
            if (!currentPdf) {
                showStatusMessage('Select a PDF first!');
                return;
            }
            if (noteText === '') return;
            try {
                await db.collection('notes').add({
                    text: noteText,
                    pdf: currentPdf,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                noteInput.value = '';
                showStatusMessage('Note saved!', 'bg-green-600');
            } catch (err) {
                console.error('Failed to save note:', err);
                showStatusMessage('Failed to save note. Check your connection.');
            }
        };

        const loadNotes = (pdfFile) => {
            // Unsubscribe old listener if any
            if (notesUnsubscribe) notesUnsubscribe();

            if (!pdfFile) {
                notesContainer.innerHTML = '<p class="text-white">Select a PDF to view notes.</p>';
                return;
            }
            notesUnsubscribe = db.collection('notes')
                .where('pdf', '==', pdfFile)
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    notesContainer.innerHTML = '';
                    if (snapshot.empty) {
                        notesContainer.innerHTML = '<p class="text-gray-400">No notes yet!</p>';
                    }
                    snapshot.forEach(doc => {
                        const note = doc.data();
                        const noteElement = document.createElement('p');
                        noteElement.className = 'text-sm text-white bg-slate-700 bg-opacity-70 p-2 rounded-md';
                        noteElement.textContent = note.text;
                        notesContainer.appendChild(noteElement);
                    });
                }, err => {
                    console.error('Error loading notes:', err);
                    notesContainer.innerHTML = '<p class="text-red-400">Failed to load notes.</p>';
                });
        };

        // Event Listeners
        pdfSelect.addEventListener('change', (event) => {
            let selectedPdfUrl = event.target.value;
            // If you use Firebase Storage, replace with download URLs!
            loadAndRenderPdf(selectedPdfUrl);
            notesSection.classList.remove('hidden');
            loadNotes(selectedPdfUrl);
        });

        togglePdfBtn.addEventListener('click', () => {
            const isVisible = pdfOverlay.style.opacity === '1';
            if (isVisible) {
                pdfOverlay.style.opacity = '0';
                pdfOverlay.style.pointerEvents = 'none';
                pdfNavLeft.classList.add('hidden');
                pdfNavRight.classList.add('hidden');
                pageInfo.classList.add('hidden');
                notesSection.classList.add('hidden');
                togglePdfBtn.textContent = 'Show PDF';
            } else {
                pdfOverlay.style.opacity = '1';
                pdfOverlay.style.pointerEvents = 'auto';
                pdfNavLeft.classList.remove('hidden');
                pdfNavRight.classList.remove('hidden');
                pageInfo.classList.remove('hidden');
                notesSection.classList.remove('hidden');
                togglePdfBtn.textContent = 'Hide PDF';
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPage(currentPage);
            }
        });

        noteForm.addEventListener('submit', saveNote);

        window.addEventListener('resize', () => {
            setOverlayDimensions();
            if (pdfDoc) {
                renderPage(currentPage);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setOverlayDimensions();
        });
    </script>
</body>
</html>
